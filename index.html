<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji Code Mood üé≠ - Version S√©curis√©e</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #3ECF8E 0%, #2B7EC8 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #3ECF8E;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        
        .security-badge {
            display: inline-flex;
            align-items: center;
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .mode-indicator {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: #f8fffc;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3ECF8E;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .form-section, .display-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .form-section h2 {
            color: #3ECF8E;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3ECF8E;
        }
        
        .emoji-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            background: #fafbfc;
        }
        
        .emoji-btn {
            padding: 12px;
            border: 2px solid #e1e8ed;
            background: white;
            border-radius: 8px;
            font-size: 1.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emoji-btn:hover {
            transform: scale(1.1);
            border-color: #3ECF8E;
        }
        
        .emoji-btn.selected {
            border-color: #3ECF8E;
            background: #f8fffc;
            transform: scale(1.1);
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #3ECF8E 0%, #2B7EC8 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            width: 100%;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .mood-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .mood-item {
            background: #f8fffc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3ECF8E;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .mood-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .student-name {
            font-weight: 600;
            color: #333;
        }
        
        .timestamp {
            font-size: 0.9em;
            color: #666;
        }
        
        .code-display {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
            position: relative;
        }
        
        .language-tag {
            position: absolute;
            top: 5px;
            right: 10px;
            background: #3ECF8E;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        
        .comment {
            color: #a0aec0;
        }
        
        .teacher-controls {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .control-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 0 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .control-btn:hover {
            transform: translateY(-1px);
        }
        
        .export-btn {
            background: #38a169;
        }
        
        .refresh-btn {
            background: #3182ce;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats {
                flex-direction: column;
                align-items: center;
            }
            
            .emoji-selector {
                grid-template-columns: repeat(4, 1fr);
                max-height: 250px;
            }
            
            .emoji-btn {
                font-size: 1.5em;
                min-height: 45px;
                padding: 8px;
            }
        }
        
        .mood-visualization {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .mood-bubble {
            display: flex;
            align-items: center;
            background: #f8fffc;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1.2em;
            border: 2px solid #e1e8ed;
        }
        
        .mood-count {
            margin-left: 8px;
            background: #3ECF8E;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="security-badge">
                üîê Version S√©curis√©e - Cl√©s API Prot√©g√©es
            </div>
            <h1>üé≠ Emoji Code Mood</h1>
            <p>Exprime ton humeur de rentr√©e avec une ligne de code !</p>
            
            <div class="mode-indicator" id="modeIndicator">
                <span id="modeIcon">‚ö°</span>
                <span id="modeText">Mode Collaboratif - Synchronisation temps r√©el</span>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalParticipants">0</div>
                    <div class="stat-label">Participants</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="moodVariety">0</div>
                    <div class="stat-label">Humeurs diff√©rentes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="sessionTime">0</div>
                    <div class="stat-label">Minutes</div>
                </div>
            </div>
            
            <div class="mood-visualization" id="moodVisualization"></div>
        </div>
        
        <div class="main-content">
            <div class="form-section">
                <h2>üìù Code ton humeur</h2>
                
                <form id="moodForm">
                    <div class="form-group">
                        <label for="studentName">Ton pr√©nom :</label>
                        <input type="text" id="studentName" required placeholder="Ex: Alex" maxlength="30">
                    </div>
                    
                    <div class="form-group">
                        <label>Choisis ton emoji :</label>
                        <div class="emoji-selector">
                            <!-- √ânergie et motivation -->
                            <button type="button" class="emoji-btn" data-emoji="üî•" title="Feu - Motiv√© √† fond">üî•</button>
                            <button type="button" class="emoji-btn" data-emoji="üí™" title="Muscle - Pr√™t au combat">üí™</button>
                            <button type="button" class="emoji-btn" data-emoji="üöÄ" title="Fus√©e - D√©collage imm√©diat">üöÄ</button>
                            <button type="button" class="emoji-btn" data-emoji="‚ö°" title="√âclair - √ânergie √©lectrique">‚ö°</button>
                            <button type="button" class="emoji-btn" data-emoji="üåü" title="√âtoile - Brillant aujourd'hui">üåü</button>
                            <button type="button" class="emoji-btn" data-emoji="‚ú®" title="√âtincelles - Magique">‚ú®</button>
                            
                            <!-- Fatigue et repos -->
                            <button type="button" class="emoji-btn" data-emoji="üò¥" title="Endormi - Mode sieste">üò¥</button>
                            <button type="button" class="emoji-btn" data-emoji="ü•±" title="B√¢illement - Fatigue">ü•±</button>
                            <button type="button" class="emoji-btn" data-emoji="‚òï" title="Caf√© - Besoin de caf√©ine">‚òï</button>
                            <button type="button" class="emoji-btn" data-emoji="üõå" title="Lit - Envie de dormir">üõå</button>
                            <button type="button" class="emoji-btn" data-emoji="üí§" title="ZZZ - Assoupi">üí§</button>
                            <button type="button" class="emoji-btn" data-emoji="üßü" title="Zombie - Mode survie">üßü</button>
                            
                            <!-- Stress et d√©fi -->
                            <button type="button" class="emoji-btn" data-emoji="ü§Ø" title="Explosion - Cerveau overload">ü§Ø</button>
                            <button type="button" class="emoji-btn" data-emoji="üò∞" title="Sueur - Stress intensif">üò∞</button>
                            <button type="button" class="emoji-btn" data-emoji="ü•µ" title="Chaud - Pression maximum">ü•µ</button>
                            <button type="button" class="emoji-btn" data-emoji="üòì" title="Goutte sueur - Inquiet">üòì</button>
                            <button type="button" class="emoji-btn" data-emoji="ü§™" title="Fou - Compl√®tement perch√©">ü§™</button>
                            <button type="button" class="emoji-btn" data-emoji="üôÉ" title="√Ä l'envers - Monde invers√©">üôÉ</button>
                            
                            <!-- Confiance et cool -->
                            <button type="button" class="emoji-btn" data-emoji="üòé" title="Cool - Ma√Ætre de l'univers">üòé</button>
                            <button type="button" class="emoji-btn" data-emoji="üòè" title="Smirk - Je sais tout">üòè</button>
                            <button type="button" class="emoji-btn" data-emoji="ü§ì" title="Geek - Mode intellectuel">ü§ì</button>
                            <button type="button" class="emoji-btn" data-emoji="üòå" title="Zen - Parfaitement serein">üòå</button>
                            <button type="button" class="emoji-btn" data-emoji="üòä" title="Sourire - Bonne humeur">üòä</button>
                            <button type="button" class="emoji-btn" data-emoji="üòÅ" title="Grand sourire - Joie">üòÅ</button>
                            
                            <!-- R√©flexion et questionnement -->
                            <button type="button" class="emoji-btn" data-emoji="ü§î" title="R√©flexion - En train de cogiter">ü§î</button>
                            <button type="button" class="emoji-btn" data-emoji="üßê" title="Monocle - Analyse pouss√©e">üßê</button>
                            <button type="button" class="emoji-btn" data-emoji="üëÄ" title="Yeux - J'observe tout">üëÄ</button>
                            <button type="button" class="emoji-btn" data-emoji="ü§®" title="Sourcil lev√© - Sceptique">ü§®</button>
                            <button type="button" class="emoji-btn" data-emoji="üò¨" title="Grimace - Pas tr√®s s√ªr">üò¨</button>
                            <button type="button" class="emoji-btn" data-emoji="üòï" title="D√©√ßu - Un peu triste">üòï</button>
                            
                            <!-- Humour et l√©g√®ret√© -->
                            <button type="button" class="emoji-btn" data-emoji="üòÖ" title="Rire nerveux - √áa va aller">üòÖ</button>
                            <button type="button" class="emoji-btn" data-emoji="üòÇ" title="Larmes de joie - Mort de rire">üòÇ</button>
                            <button type="button" class="emoji-btn" data-emoji="ü§£" title="Rire aux √©clats - Explosion">ü§£</button>
                            <button type="button" class="emoji-btn" data-emoji="üòÑ" title="Sourire √©clatant - Super content">üòÑ</button>
                            <button type="button" class="emoji-btn" data-emoji="ü•≥" title="F√™te - Mode c√©l√©bration">ü•≥</button>
                            <button type="button" class="emoji-btn" data-emoji="üéâ" title="Confettis - Party time">üéâ</button>
                            
                            <!-- Tech et geek -->
                            <button type="button" class="emoji-btn" data-emoji="üíª" title="Laptop - Mode d√©veloppeur">üíª</button>
                            <button type="button" class="emoji-btn" data-emoji="üñ•Ô∏è" title="Desktop - Workstation ready">üñ•Ô∏è</button>
                            <button type="button" class="emoji-btn" data-emoji="‚å®Ô∏è" title="Clavier - Ready to code">‚å®Ô∏è</button>
                            <button type="button" class="emoji-btn" data-emoji="ü§ñ" title="Robot - IA activated">ü§ñ</button>
                            <button type="button" class="emoji-btn" data-emoji="üëæ" title="Alien - Mode gaming">üëæ</button>
                            <button type="button" class="emoji-btn" data-emoji="üéØ" title="Cible - Objectif lock">üéØ</button>
                            
                            <!-- Sp√©ciaux -->
                            <button type="button" class="emoji-btn" data-emoji="ü¶Ñ" title="Licorne - Mood magique">ü¶Ñ</button>
                            <button type="button" class="emoji-btn" data-emoji="üé≠" title="Masques - Humeur th√©√¢trale">üé≠</button>
                            <button type="button" class="emoji-btn" data-emoji="üé≤" title="D√© - Mood al√©atoire">üé≤</button>
                            <button type="button" class="emoji-btn" data-emoji="üåà" title="Arc-en-ciel - Toutes les couleurs">üåà</button>
                            <button type="button" class="emoji-btn" data-emoji="üçï" title="Pizza - Mood gourmand">üçï</button>
                            <button type="button" class="emoji-btn" data-emoji="üé∏" title="Guitare - Rock'n'code">üé∏</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="language">Langage de programmation :</label>
                        <select id="language" required>
                            <option value="">Choisis un langage</option>
                            <option value="javascript">JavaScript</option>
                            <option value="typescript">TypeScript</option>
                            <option value="python">Python</option>
                            <option value="java">Java</option>
                            <option value="csharp">C#</option>
                            <option value="php">PHP</option>
                            <option value="cpp">C++</option>
                            <option value="rust">Rust</option>
                            <option value="go">Go</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="comment">Commentaire (optionnel) :</label>
                        <input type="text" id="comment" placeholder="Clique pour des id√©es..." list="commentSuggestions" maxlength="100">
                        <datalist id="commentSuggestions">
                            <option value="pr√™t pour attaquer les projets">
                            <option value="besoin d'un deuxi√®me caf√©">
                            <option value="cerveau en surchauffe">
                            <option value="easy peasy lemon squeezy">
                            <option value="mode r√©flexion intense">
                            <option value="je fais semblant de comprendre">
                            <option value="404 motivation not found">
                            <option value="mood de licorne cosmique">
                            <option value="while(motivation) { code(); }">
                            <option value="git commit -m 'nouvelle ann√©e'">
                            <option value="printf('hello world');">
                            <option value="sudo apt install motivation">
                            <option value="import happiness from 'vacation'">
                            <option value="let mood = 'awesome'">
                            <option value="humeur = 'super'">
                        </datalist>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="submitBtn">Envoyer mon code mood ! üöÄ</button>
                </form>
            </div>
            
            <div class="display-section">
                <h2>üíª Mood Board de la classe</h2>
                <div class="mood-list" id="moodList">
                    <div class="loading">
                        <p>ü§ñ En attente des premiers codes mood...</p>
                        <p style="font-size: 0.9em; margin-top: 10px; color: #666;">
                            Mode collaboratif activ√© - Synchronisation temps r√©el
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="teacher-controls">
            <h3 style="margin-bottom: 15px; color: #3ECF8E;">üéì Contr√¥les enseignant</h3>
            <button class="control-btn refresh-btn" onclick="loadMoods()">üîÑ Actualiser</button>
            <button class="control-btn" onclick="clearAllMoods()">üóëÔ∏è Effacer tout</button>
            <button class="control-btn export-btn" onclick="exportMoods()">üìÑ Exporter CSV</button>
            <button class="control-btn export-btn" onclick="exportMoodsJSON()">üíæ Export JSON</button>
        </div>
    </div>

    <!-- Configuration priv√©e inject√©e automatiquement par GitHub Actions -->
    <!-- PRIVATE_CONFIG_PLACEHOLDER -->

    <script type="module">
        // ========================================
        // CONFIGURATION ET INITIALISATION
        // ========================================
        
        console.log('üé≠ Emoji Code Mood - Version S√©curis√©e v2.0');
        
        // Configuration par d√©faut (mode local)
        let CONFIG = {
            mode: 'local',
            supabaseUrl: null,
            supabaseAnonKey: null,
            useRealtime: false
        };
        
        // D√©tection automatique de la configuration priv√©e
        if (typeof window.PRIVATE_CONFIG !== 'undefined') {
            CONFIG = { ...CONFIG, ...window.PRIVATE_CONFIG };
            console.log('‚úÖ Configuration priv√©e d√©tect√©e - Mode Supabase activ√©');
        } else {
            console.log('üì¶ Mode local activ√© - Donn√©es stock√©es dans le navigateur');
        }
        
        // Variables globales
        let supabase = null;
        let moods = [];
        let selectedEmoji = '';
        let sessionStartTime = new Date();
        
        // ========================================
        // INITIALISATION SUPABASE
        // ========================================
        
        async function initSupabase() {
            try {
                if (CONFIG.mode === 'supabase' && CONFIG.supabaseUrl && CONFIG.supabaseAnonKey) {
                    const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
                    
                    supabase = createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);
                    
                    // Test de connexion
                    const { data, error } = await supabase.from('moods').select('count').limit(1);
                    if (error) {
                        console.warn('‚ö†Ô∏è Erreur Supabase, basculement en mode local:', error.message);
                        CONFIG.mode = 'local';
                        return false;
                    }
                    
                    console.log('üöÄ Supabase connect√© avec succ√®s');
                    await loadMoodsFromSupabase();
                    setupRealtimeSubscription();
                    return true;
                }
                return false;
            } catch (error) {
                console.warn('‚ö†Ô∏è Erreur d\'initialisation Supabase:', error);
                CONFIG.mode = 'local';
                return false;
            }
        }
        
        async function loadMoodsFromSupabase() {
            if (!supabase) return;
            
            try {
                const { data, error } = await supabase
                    .from('moods')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (error) throw error;
                
                moods = data || [];
                updateDisplay();
                console.log(`üìä ${moods.length} mood codes charg√©s depuis Supabase`);
            } catch (error) {
                console.error('‚ùå Erreur chargement Supabase:', error);
            }
        }
        
        function setupRealtimeSubscription() {
            if (!supabase) return;
            
            supabase
                .channel('moods_realtime')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'moods' },
                    (payload) => {
                        console.log('üîÑ Changement temps r√©el:', payload.eventType);
                        
                        if (payload.eventType === 'INSERT') {
                            moods.unshift(payload.new);
                            updateDisplay();
                            
                            // Animation d'arriv√©e
                            setTimeout(() => {
                                const newItem = document.querySelector('.mood-item');
                                if (newItem) newItem.style.animation = 'slideIn 0.5s ease';
                            }, 100);
                        } else if (payload.eventType === 'DELETE') {
                            loadMoodsFromSupabase();
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('üì° Realtime status:', status);
                });
        }
        
        // ========================================
        // MODE LOCAL
        // ========================================
        
        function initLocalMode() {
            console.log('üíæ Mode local initialis√©');
            moods = JSON.parse(localStorage.getItem('emoji-mood-local') || '[]');
            updateDisplay();
            
            // Mise √† jour de l'interface
            const modeIndicator = document.getElementById('modeIndicator');
            const modeIcon = document.getElementById('modeIcon');
            const modeText = document.getElementById('modeText');
            
            modeIndicator.style.background = '#fff3e0';
            modeIndicator.style.color = '#f57c00';
            modeIndicator.style.borderColor = '#ffcc02';
            modeIcon.textContent = 'üíæ';
            modeText.textContent = 'Mode Local - Donn√©es stock√©es dans ce navigateur';
        }
        
        function saveLocalMoods() {
            localStorage.setItem('emoji-mood-local', JSON.stringify(moods));
        }
        
        // ========================================
        // GESTION DES MOOD CODES
        // ========================================
        
        async function addMood(mood) {
            mood.created_at = new Date().toISOString();
            
            if (CONFIG.mode === 'supabase' && supabase) {
                try {
                    const { data, error } = await supabase
                        .from('moods')
                        .insert([mood])
                        .select();
                    
                    if (error) throw error;
                    console.log('‚úÖ Mood ajout√© √† Supabase');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erreur ajout Supabase:', error);
                    // Fallback local
                    mood.id = Date.now();
                    moods.unshift(mood);
                    saveLocalMoods();
                    updateDisplay();
                    return true;
                }
            } else {
                // Mode local
                mood.id = Date.now();
                moods.unshift(mood);
                saveLocalMoods();
                updateDisplay();
                return true;
            }
        }
        
        // ========================================
        // INTERFACE UTILISATEUR
        // ========================================
        
        function setupEventListeners() {
            // Gestion de la s√©lection d'emoji
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedEmoji = btn.dataset.emoji;
                });
            });
            
            // Gestion du formulaire
            document.getElementById('moodForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitMood();
            });
            
            // Timer de session
            setInterval(() => {
                const minutes = Math.floor((new Date() - sessionStartTime) / 60000);
                document.getElementById('sessionTime').textContent = minutes;
            }, 60000);
        }
        
        async function submitMood() {
            const name = document.getElementById('studentName').value.trim();
            const language = document.getElementById('language').value;
            const comment = document.getElementById('comment').value.trim();
            const submitBtn = document.getElementById('submitBtn');
            
            // Validations
            if (!selectedEmoji) {
                alert('N\'oublie pas de choisir un emoji ! üòä');
                return;
            }
            
            if (name.length < 2) {
                alert('Le pr√©nom doit contenir au moins 2 caract√®res');
                return;
            }
            
            const mood = {
                name: name,
                emoji: selectedEmoji,
                language: language,
                comment: comment || null
            };
            
            // Animation de chargement
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'üîÑ Envoi en cours...';
            submitBtn.disabled = true;
            
            const success = await addMood(mood);
            
            if (success) {
                resetForm();
                submitBtn.textContent = '‚úÖ Envoy√© avec succ√®s !';
                setTimeout(() => {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }, 2500);
            } else {
                submitBtn.textContent = '‚ùå Erreur - R√©essayer';
                setTimeout(() => {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }, 3000);
            }
        }
        
        function resetForm() {
            document.getElementById('moodForm').reset();
            document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
            selectedEmoji = '';
        }
        
        // ========================================
        // AFFICHAGE ET VISUALISATION
        // ========================================
        
        function updateDisplay() {
            updateStats();
            updateMoodList();
            updateVisualization();
        }
        
        function updateStats() {
            document.getElementById('totalParticipants').textContent = moods.length;
            
            const uniqueEmojis = new Set(moods.map(m => m.emoji));
            document.getElementById('moodVariety').textContent = uniqueEmojis.size;
            
            const minutes = Math.floor((new Date() - sessionStartTime) / 60000);
            document.getElementById('sessionTime').textContent = minutes;
        }
        
        function updateMoodList() {
            const listContainer = document.getElementById('moodList');
            
            if (moods.length === 0) {
                const modeText = CONFIG.mode === 'supabase' ? 
                    'Synchronisation temps r√©el active' : 
                    'Mode local - Donn√©es dans ce navigateur';
                    
                listContainer.innerHTML = `
                    <div class="loading">
                        <p>ü§ñ En attente des premiers codes mood...</p>
                        <p style="font-size: 0.9em; margin-top: 10px; color: #666;">${modeText}</p>
                    </div>
                `;
                return;
            }
            
            listContainer.innerHTML = moods.map(mood => {
                const codeSnippet = generateCodeSnippet(mood);
                const timeDisplay = formatTime(mood.created_at);
                
                return `
                    <div class="mood-item">
                        <div class="mood-header">
                            <span class="student-name">${escapeHtml(mood.name)}</span>
                            <span class="timestamp">${timeDisplay}</span>
                        </div>
                        <div class="code-display">
                            <div class="language-tag">${mood.language}</div>
                            ${codeSnippet}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function generateCodeSnippet(mood) {
            const templates = {
                javascript: `let mood = "${mood.emoji}";${mood.comment ? ` <span class="comment">// ${escapeHtml(mood.comment)}</span>` : ''}`,
                typescript: `const mood: string = "${mood.emoji}";${mood.comment ? ` <span class="comment">// ${escapeHtml(mood.comment)}</span>` : ''}`,
                python: `humeur = "${mood.emoji}"${mood.comment ? `  <span class="comment"># ${escapeHtml(mood.comment)}</span>` : ''}`,
                java: `String mood = "${mood.emoji}";${mood.comment ? ` <span class="comment">// ${escapeHtml(mood.comment)}</span>` : ''}`,
                csharp: `string mood = "${mood.emoji}";${mood.comment ? ` <span class="comment">// ${escapeHtml(mood.comment)}</span>` : ''}`,
                php: `$mood = "${mood.emoji}";${mood.comment ? ` <span class="comment">// ${escapeHtml(mood.comment)}</span>` : ''}`,
                cpp: `std::string mood = "${mood.emoji}";${mood.comment ? ` <span class="comment">// ${escapeHtml(mood.comment)}</span>` : ''}`,
                rust: `let mood = "${mood.emoji}";${mood.comment ? ` <span class="comment">// ${escapeHtml(mood.comment)}</span>` : ''}`,
                go: `mood := "${mood.emoji}"${mood.comment ? ` <span class="comment">// ${escapeHtml(mood.comment)}</span>` : ''}`
            };
            
            return templates[mood.language] || `mood = "${mood.emoji}";${mood.comment ? ` // ${escapeHtml(mood.comment)}` : ''}`;
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMinutes = Math.floor((now - date) / 60000);
            
            if (diffMinutes < 1) return '√Ä l\'instant';
            if (diffMinutes < 60) return `${diffMinutes}min`;
            if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h${diffMinutes % 60 > 0 ? diffMinutes % 60 + 'min' : ''}`;
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function updateVisualization() {
            const container = document.getElementById('moodVisualization');
            
            if (moods.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            const emojiCounts = {};
            moods.forEach(mood => {
                emojiCounts[mood.emoji] = (emojiCounts[mood.emoji] || 0) + 1;
            });
            
            container.innerHTML = Object.entries(emojiCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([emoji, count]) => `
                    <div class="mood-bubble">
                        <span>${emoji}</span>
                        <span class="mood-count">${count}</span>
                    </div>
                `).join('');
        }
        
        // ========================================
        // CONTR√îLES ENSEIGNANT
        // ========================================
        
        window.loadMoods = async function() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'üîÑ Actualisation...';
            btn.disabled = true;
            
            try {
                if (CONFIG.mode === 'supabase' && supabase) {
                    await loadMoodsFromSupabase();
                } else {
                    moods = JSON.parse(localStorage.getItem('emoji-mood-local') || '[]');
                    updateDisplay();
                }
                btn.textContent = '‚úÖ Actualis√©';
            } catch (error) {
                btn.textContent = '‚ùå Erreur';
                console.error('Erreur actualisation:', error);
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 2000);
        };
        
        window.clearAllMoods = async function() {
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer TOUS les mood codes ?')) {
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'üóëÔ∏è Suppression...';
            btn.disabled = true;
            
            try {
                if (CONFIG.mode === 'supabase' && supabase) {
                    const { error } = await supabase
                        .from('moods')
                        .delete()
                        .neq('id', 0);
                    
                    if (error) throw error;
                } else {
                    moods = [];
                    saveLocalMoods();
                    updateDisplay();
                }
                btn.textContent = '‚úÖ Effac√©';
            } catch (error) {
                btn.textContent = '‚ùå Erreur';
                console.error('Erreur suppression:', error);
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 2000);
        };
        
        window.exportMoods = function() {
            if (moods.length === 0) {
                alert('Aucun mood code √† exporter !');
                return;
            }
            
            const exportData = moods.map(mood => ({
                Pr√©nom: mood.name,
                Emoji: mood.emoji,
                Langage: mood.language,
                Commentaire: mood.comment || '',
                'Date/Heure': formatTime(mood.created_at),
                Timestamp: mood.created_at,
                Mode: CONFIG.mode
            }));
            
            const headers = Object.keys(exportData[0]);
            const csvContent = [
                headers.join(','),
                ...exportData.map(row => 
                    headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(',')
                )
            ].join('\n');
            
            downloadFile(csvContent, `emoji-code-mood-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        };
        
        window.exportMoodsJSON = function() {
            if (moods.length === 0) {
                alert('Aucun mood code √† exporter !');
                return;
            }
            
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    mode: CONFIG.mode,
                    sessionDuration: Math.floor((new Date() - sessionStartTime) / 60000),
                    totalParticipants: moods.length,
                    uniqueEmojis: new Set(moods.map(m => m.emoji)).size,
                    version: 'secure-2.0'
                },
                moods: moods,
                analytics: generateAnalytics()
            };
            
            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, `emoji-code-mood-session-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        };
        
        function generateAnalytics() {
            const emojiStats = {};
            const languageStats = {};
            
            moods.forEach(mood => {
                emojiStats[mood.emoji] = (emojiStats[mood.emoji] || 0) + 1;
                languageStats[mood.language] = (languageStats[mood.language] || 0) + 1;
            });
            
            return {
                emojiDistribution: emojiStats,
                languagePreferences: languageStats,
                topEmojis: Object.entries(emojiStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([emoji, count]) => ({ emoji, count, percentage: Math.round(count / moods.length * 100) }))
            };
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // ========================================
        // INITIALISATION DE L'APPLICATION
        // ========================================
        
        async function initApp() {
            console.log('üöÄ Initialisation Emoji Code Mood...');
            
            // Configuration des event listeners d'abord
            setupEventListeners();
            
            // Tentative d'initialisation Supabase
            const supabaseSuccess = await initSupabase();
            
            if (!supabaseSuccess) {
                console.log('üîÑ Basculement en mode local...');
                initLocalMode();
            }
            
            // Mise √† jour initiale de l'affichage
            updateDisplay();
            
            console.log('‚úÖ Application initialis√©e avec succ√®s');
            console.log('üìä Mode actuel:', CONFIG.mode);
            console.log('üìà Mood codes charg√©s:', moods.length);
        }
        
        // D√©marrage automatique - Multiple m√©thodes pour assurer le chargement
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            // Le DOM est d√©j√† charg√©
            initApp();
        }
        
        // Fallback suppl√©mentaire
        window.addEventListener('load', () => {
            // V√©rifier si l'app n'est pas encore initialis√©e
            if (moods.length === 0 && !document.querySelector('.mood-item')) {
                console.log('üîÑ Initialisation fallback...');
                initApp();
            }
        });
        
        // Auto-d√©tection si le fichier private-config.js est pr√©sent
        // Pour utiliser vos propres cl√©s, cr√©ez ce fichier localement :
        /*
        window.PRIVATE_CONFIG = {
            mode: 'supabase',
            supabaseUrl: 'https://xxx.supabase.co',
            supabaseAnonKey: 'eyJ...',
            useRealtime: true
        };
        */
        
        // Debug helper - Vous pouvez supprimer cette section en production
        window.debugEmojiMood = {
            addTestMood: () => {
                const testMood = {
                    name: 'Test User',
                    emoji: 'üß™',
                    language: 'javascript',
                    comment: 'Test mood code',
                    id: Date.now(),
                    created_at: new Date().toISOString()
                };
                moods.unshift(testMood);
                if (CONFIG.mode === 'local') saveLocalMoods();
                updateDisplay();
                console.log('‚úÖ Mood de test ajout√©');
            },
            getConfig: () => CONFIG,
            getMoods: () => moods,
            clearMoods: () => {
                moods = [];
                if (CONFIG.mode === 'local') saveLocalMoods();
                updateDisplay();
            }
        };
        
        // Message de debug dans la console
        console.log('üé≠ Emoji Code Mood charg√© !');
        console.log('üîß Pour tester: window.debugEmojiMood.addTestMood()');
        
    </script>
</body>
</html>
